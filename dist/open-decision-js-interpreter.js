!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("OpenDecisionJSInterpreter",[],e):"object"==typeof exports?exports.OpenDecisionJSInterpreter=e():t.OpenDecisionJSInterpreter=e()}(this,(function(){return(()=>{var t={180:function(t,e,r){var n,i;void 0===(i="function"==typeof(n=function(){"use strict";Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)});var t={},e={"==":function(t,e){return t==e},"===":function(t,e){return t===e},"!=":function(t,e){return t!=e},"!==":function(t,e){return t!==e},">":function(t,e){return t>e},">=":function(t,e){return t>=e},"<":function(t,e,r){return void 0===r?t<e:t<e&&e<r},"<=":function(t,e,r){return void 0===r?t<=e:t<=e&&e<=r},"!!":function(e){return t.truthy(e)},"!":function(e){return!t.truthy(e)},"%":function(t,e){return t%e},log:function(t){return console.log(t),t},in:function(t,e){return!(!e||void 0===e.indexOf)&&-1!==e.indexOf(t)},cat:function(){return Array.prototype.join.call(arguments,"")},substr:function(t,e,r){if(r<0){var n=String(t).substr(e);return n.substr(0,n.length+r)}return String(t).substr(e,r)},"+":function(){return Array.prototype.reduce.call(arguments,(function(t,e){return parseFloat(t,10)+parseFloat(e,10)}),0)},"*":function(){return Array.prototype.reduce.call(arguments,(function(t,e){return parseFloat(t,10)*parseFloat(e,10)}))},"-":function(t,e){return void 0===e?-t:t-e},"/":function(t,e){return t/e},min:function(){return Math.min.apply(this,arguments)},max:function(){return Math.max.apply(this,arguments)},merge:function(){return Array.prototype.reduce.call(arguments,(function(t,e){return t.concat(e)}),[])},var:function(t,e){var r=void 0===e?null:e,n=this;if(void 0===t||""===t||null===t)return n;for(var i=String(t).split("."),s=0;s<i.length;s++){if(null==n)return r;if(void 0===(n=n[i[s]]))return r}return n},missing:function(){for(var e=[],r=Array.isArray(arguments[0])?arguments[0]:arguments,n=0;n<r.length;n++){var i=r[n],s=t.apply({var:i},this);null!==s&&""!==s||e.push(i)}return e},missing_some:function(e,r){var n=t.apply({missing:r},this);return r.length-n.length>=e?[]:n}};return t.is_logic=function(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)&&1===Object.keys(t).length},t.truthy=function(t){return!(Array.isArray(t)&&0===t.length||!t)},t.get_operator=function(t){return Object.keys(t)[0]},t.get_values=function(e){return e[t.get_operator(e)]},t.apply=function(r,n){if(Array.isArray(r))return r.map((function(e){return t.apply(e,n)}));if(!t.is_logic(r))return r;var i,s,o,a,u,l=t.get_operator(r),c=r[l];if(Array.isArray(c)||(c=[c]),"if"===l||"?:"==l){for(i=0;i<c.length-1;i+=2)if(t.truthy(t.apply(c[i],n)))return t.apply(c[i+1],n);return c.length===i+1?t.apply(c[i],n):null}if("and"===l){for(i=0;i<c.length;i+=1)if(s=t.apply(c[i],n),!t.truthy(s))return s;return s}if("or"===l){for(i=0;i<c.length;i+=1)if(s=t.apply(c[i],n),t.truthy(s))return s;return s}if("filter"===l)return a=t.apply(c[0],n),o=c[1],Array.isArray(a)?a.filter((function(e){return t.truthy(t.apply(o,e))})):[];if("map"===l)return a=t.apply(c[0],n),o=c[1],Array.isArray(a)?a.map((function(e){return t.apply(o,e)})):[];if("reduce"===l)return a=t.apply(c[0],n),o=c[1],u=void 0!==c[2]?c[2]:null,Array.isArray(a)?a.reduce((function(e,r){return t.apply(o,{current:r,accumulator:e})}),u):u;if("all"===l){if(a=t.apply(c[0],n),o=c[1],!a.length)return!1;for(i=0;i<a.length;i+=1)if(!t.truthy(t.apply(o,a[i])))return!1;return!0}if("none"===l)return 0===t.apply({filter:c},n).length;if("some"===l)return t.apply({filter:c},n).length>0;if(c=c.map((function(e){return t.apply(e,n)})),e.hasOwnProperty(l)&&"function"==typeof e[l])return e[l].apply(n,c);if(l.indexOf(".")>0){var p=String(l).split("."),d=e;for(i=0;i<p.length;i++){if(!d.hasOwnProperty(p[i]))throw new Error("Unrecognized operation "+l+" (failed at "+p.slice(0,i+1).join(".")+")");d=d[p[i]]}return d.apply(n,c)}throw new Error("Unrecognized operation "+l)},t.uses_data=function(e){var r=[];if(t.is_logic(e)){var n=t.get_operator(e),i=e[n];Array.isArray(i)||(i=[i]),"var"===n?r.push(i[0]):i.map((function(e){r.push.apply(r,t.uses_data(e))}))}return function(t){for(var e=[],r=0,n=t.length;r<n;r++)-1===e.indexOf(t[r])&&e.push(t[r]);return e}(r)},t.add_operation=function(t,r){e[t]=r},t.rm_operation=function(t){delete e[t]},t.rule_like=function(e,r){if(r===e)return!0;if("@"===r)return!0;if("number"===r)return"number"==typeof e;if("string"===r)return"string"==typeof e;if("array"===r)return Array.isArray(e)&&!t.is_logic(e);if(t.is_logic(r)){if(t.is_logic(e)){var n=t.get_operator(r),i=t.get_operator(e);if("@"===n||n===i)return t.rule_like(t.get_values(e,!1),t.get_values(r,!1))}return!1}if(Array.isArray(r)){if(Array.isArray(e)){if(r.length!==e.length)return!1;for(var s=0;s<r.length;s+=1)if(!t.rule_like(e[s],r[s]))return!1;return!0}return!1}return!1},t})?n.call(e,r,e,t):n)||(t.exports=i)}},e={};function r(n){var i=e[n];if(void 0!==i)return i.exports;var s=e[n]={exports:{}};return t[n].call(s.exports,s,s.exports,r),s.exports}r.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return r.d(e,{a:e}),e},r.d=(t,e)=>{for(var n in e)r.o(e,n)&&!r.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var n={};return(()=>{"use strict";r.d(n,{default:()=>i});var t=r(180),e=r.n(t);const i=class{constructor(t,r,n={},i=!1){this.renderData={},this.core=new class{constructor(t,e=!1){this.tree=t,this.currentNode=this.tree.header.start_node,this.history={nodes:[],answers:{}},this.state="initialized",this.supportsFileApi=!1,this.COMPATIBLE_VERSIONS=[.1]}startInterpretation(){return this.state="started",this.getCurrentNode()}getCurrentNode(){return{question:this.replaceVars(this.tree[this.currentNode].text,this.history.answers),inputs:this.tree[this.currentNode].inputs}}interpret(t){return this.state="interpreting",this.history.nodes.push(this.currentNode),this.history.answers[this.currentNode]=t,this.currentNode=((t,r)=>{if("default"in t.destination)return t.destination.default;if(0===Object.keys(t.rules).length)return t.destination[r];const n=e().apply(t.rules,r);return t.destination[n]})(this.tree[this.currentNode],t),this.state="idle",this.getCurrentNode()}get treeName(){return this.tree.header.tree_name}goBack(){return this.history.nodes.length>0?(delete this.history.answers[this.currentNode],this.currentNode=this.history.nodes.pop()):(this.currentNode=this.tree.header.start_node,this.history={nodes:[],answers:{}}),this.getCurrentNode()}reset(){return this.currentNode=this.tree.header.start_node,this.history={nodes:[],answers:{}},this.getCurrentNode()}getInterpretationState(){let t={header:{...this.tree.header},log:{...this.history},currentNode:this.currentNode};return JSON.stringify(t)}setInterpretationState(t){let e=JSON.parse(t);e.header.tree_slug===this.tree.header.tree_slug?(this.currentNode=e.currentNode,this.history=e.log,this.getCurrentNode()):alert("Please load the correct save data.")}checkCompatibility(){let t=!1;for(var e=0;e<COMPATIBLE_VERSIONS.length;e++)COMPATIBLE_VERSIONS[e]===this.tree.header.version&&(t=!0);if(!t)throw{name:"IncompatibleVersion",message:`The provided file uses the Open Decision dataformat version ${this.tree.header.version}. This library only supports ${COMPATIBLE_VERSIONS}.`,toString:function(){return this.name+": "+this.message}}}replaceVars(t,e){let r=/\[\[([^\]]+)]]/g,n=r.exec(t);for(;null!=n;){let i;n[1]=n[1].trim();let s=n[1].indexOf(".");if(-1!==s){let t=n[1].substring(0,s),r=n[1].substring(s+1);i=t in e?e[t][r]:"MISSING"}else i=n[1]in e?e[n[1]]:"MISSING";if("number"==typeof i)try{let t=tree[n[1]].inputs[0].options[i];void 0!==t&&(i=t)}catch{}else if("object"==typeof i)try{i=e[n[1]].a}catch{}t=t.replace(n[0],i),n=r.exec(t)}return t}}(t,i),this.selectedDiv=r,this.preString="",this.defaultCss={container:{headingContainer:"",questionContainer:"",inputContainer:"",controlsContainer:""},heading:"",answerButton:"btn btn-primary ml-2",answerList:"",numberInput:"",dateInput:"",freeText:{short:"",long:"",number:""},controls:{submitButton:"btn btn-primary ml-2 mt-3",restartButton:"btn btn-primary ml-2 mt-3",backButton:"btn btn-primary ml-2 mt-3",saveProgressButton:"btn btn-primary ml-2 mt-3",saveDataInputField:""}},this.css={...this.defaultCss,...n}}displayTree(){this.renderData=this.core.startInterpretation(),this.preString=`<div class="${this.css.container.headingContainer}"><h3 class="${this.css.heading}">${this.core.tree.header.tree_name}</h3></div><br>`,this.displayNode()}displayNode(){location.hash=this.core.currentNode;let t=this.renderData.question,e=`${this.preString}<div class="${this.css.container.questionContainer}"${t}</div><br><div id="od-input-div" class="${this.css.container.inputContainer}">`;for(let t of this.renderData.inputs)if("button"===t.type)for(const[r,n]of t.options.entries())e+=`<button type="button" id="answer-button" class="${this.css.answerButton}" value="${r}">${n}</button>`;else if("list"===t.type){e+=`<select id="list-select" class="od-input list-select ${this.css.answerList}">`;for(const[r,n]of t.options.entries())e+=`<option value=${r}>${n}</option>`;e+="</select>"}else"number"===t.type?e+=`<input type="number" id="number-input" class="od-input number-input ${this.css.numberInput}">`:"date"===t.type?e+=`<input type="number" id="date-input" class="od-input date-input ${this.css.dateInput}">`:"free_text"===t.type&&("short_text"===t.validation?e+=`<label for="${t.id}" >${t.label}<br><input type="text" id="${t.id}" class="free-text short-text od-input ${this.css.freeText.short}"></label>`:"long_text"===t.validation?e+=`<textarea id="${t.id}" class="free-text long-text  od-input ${this.css.freeText.long}" rows="4" cols="10"></textarea>`:"number"===t.validation&&(e+=`<input type="number" id="${t.id}" class="free-text number od-input ${this.css.freeText.number}">`));0!==this.renderData.inputs.length&&"button"!==this.renderData.inputs[0].type&&(e+=`<br><button type="button" class="${this.css.controls.submitButton}" id="submit-button">Submit</button>`),e+=`</div><br><div class="${this.css.container.controlsContainer}"><button type="button" class="${this.css.controls.restartButton}" id="restart-button">Restart</button><button type="button" class="${this.css.controls.backButton}" id="back-button">Back</button>`,this.supportsFileApi?this.this.core.currentNode===this.core.tree.header.start_node?e+=`<input class="${this.css.controls.saveDataInputField}" accept="application/JSON" type="file" id="files" name="files[]"/></div>`:e+=`<button type="button" class=" ${this.css.controls.saveProgressButton}" id="save-progress-button">Save Progress</button></div>`:e+="</div>",document.getElementById(this.selectedDiv).innerHTML=e,document.getElementById(this.selectedDiv).addEventListener("click",this)}listener(t){let e=t.target||t.srcElement;if("answer-button"==e.id){let t=parseInt(e.value);console.log(t),this.renderData=this.core.interpret(t),this.displayNode()}else if("submit-button"==e.id){let t=document.getElementById(this.selectedDiv).querySelector("#od-input-div").querySelectorAll(".od-input"),e={};for(const[r,n]of t.entries())if(n.classList.contains("list-select")){let t=parseInt(n.value);e.a=this.core.tree[this.core.currentNode].inputs[r].options[t]}else(n.classList.contains("number-input")||n.classList.contains("date-input")||n.classList.contains("free-text"))&&(e.a=n.value);this.renderData=this.core.interpret(e),this.displayNode()}else if("restart-button"==e.id)this.renderData=this.core.reset(),this.displayNode();else if("back-button"==e.id)this.renderData=this.core.goBack(),this.displayNode();else if("save-progress-button"==e.id){let t=JSON.stringify(this.core.getInterpretationState()),e=`${this.core.tree.header.tree_name} - Saved.json`,r=document.createElement("a");r.setAttribute("href","data:application/JSON;charset=utf-8,"+encodeURIComponent(t)),r.setAttribute("download",e),r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}}handleEvent(t){this.listener(t)}}})(),n.default})()}));